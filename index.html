<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>IV Therapy Interactive Game</title>
  <style>
    /* Basic Styles */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f3f4f6;
    }
    header {
      background-color: #0078D7;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.8rem;
    }
    .opener {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f9f9f9;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .opener img {
      max-width: 80%;
      height: auto;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .opener h1 {
      font-size: 2rem;
      color: #333;
    }
    .opener p {
      font-size: 1.2rem;
      color: #555;
      margin: 10px 0 20px;
      line-height: 1.5;
    }
    .opener button {
      padding: 15px 30px;
      font-size: 1.2rem;
      border: none;
      background-color: #0078D7;
      color: white;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    .opener button:hover {
      background-color: #005bb5;
    }

    main {
      padding: 20px;
      display: none; /* Initially hide the main content */
      max-width: 900px;
      margin: 0 auto;
    }
    .question {
      display: none; /* Hide all questions initially */
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      position: relative; /* for absolutely positioned elements if needed */
    }
    .question.active {
      display: block; /* Show only the active question */
    }

    /* Buttons */
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background-color: #0078D7;
      color: white;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #005bb5;
    }
    .disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    /* Feedback text */
    .feedback {
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.2rem;
    }
    .feedback.correct {
      color: green;
    }
    .feedback.incorrect {
      color: red;
    }

    #scoreBoard {
      margin-bottom: 20px;
      font-size: 1.2rem;
      color: #333;
      text-align: center;
    }
    #timer {
      font-size: 1.2rem;
      color: #FF0000;
      text-align: center;
      margin-bottom: 20px;
    }
    /* Final Message as a question block so .active can apply */
    #finalMessage {
      display: none;
      text-align: center;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    #finalMessage.active {
      display: block; /* Force finalMessage to appear */
    }

    /* Q3 custom styling for clickable boxes */
    .clickable-zone {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: rgba(255,0,0,0.3); /* semi-transparent red box */
      border: 2px solid #FF0000;
      cursor: pointer;
    }
    .clickable-zone.correct:hover {
      background-color: rgba(0,255,0,0.3);
      border-color: green;
    }
    .clickable-zone.wrong:hover {
      background-color: rgba(255,0,0,0.5);
      border-color: darkred;
    }

    /* Admin / Leaderboard styling */
    #adminSection {
      display: none; /* Hidden by default */
      background: #fff;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #adminSection table {
      width: 100%;
      border-collapse: collapse;
    }
    #adminSection th, #adminSection td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    /* Drag & Drop (Q4) */
    #draggable-list {
      list-style-type: none;
      margin: 0 auto;
      padding: 0;
      max-width: 250px;
      min-width: 200px;
    }
    #draggable-list li {
      padding: 15px;
      margin: 8px 0;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: move;
      user-select: none;
      text-align: center;
      font-size: 1.1rem;
    }
    .dragging {
      opacity: 0.5;
    }

  </style>
</head>
<body>

<!-- Opener Screen -->
<div class="opener" id="opener">
  <img src="prisma-health-2-1.jpg" alt="IV Therapy Kahoot Challenge">
  <h1>IV Therapy Challenge</h1>
  <p>Welcome to the IV Therapy Interactive Game</p>
  <button onclick="promptUsername()">Start Game</button>
</div>

<!-- Game Section -->
<header>IV Therapy Interactive Game</header>
<main id="main-content">

  <!-- Admin login button / scoreboard toggler -->
  <div style="text-align:right; margin-bottom:10px;">
    <button onclick="adminLogin()">Admin Login</button>
  </div>

  <div id="scoreBoard">
    <strong>Score:</strong> <span id="score">0</span>
    <br/>
    <strong>Player:</strong> <span id="playerName"></span>
  </div>
  <div id="timer">Time Left: 60s</div>


  <!-- Question 1 -->
  <div class="question active" id="q1">
    <h2>Question 1: What are common sites to avoid when starting an IV? (Select all that apply)</h2>
    <img src="iv_placement.jpeg" 
         alt="IV Placement Guide" 
         style="max-width:100%; height:auto; margin-bottom:15px;">
    <form id="q1-form">
      <div class="options">
        <label><input type="checkbox" name="answer" value="correct1">Extremities with an AV Fistula, graft, or known clot</label><br/>
        <label><input type="checkbox" name="answer" value="correct2">Extremity affected by stroke, radiation therapy, or lymphedema</label><br/>
        <label><input type="checkbox" name="answer" value="correct3">Areas of flexion, lower extremity, or open wounds</label><br/>
        <label><input type="checkbox" name="answer" value="incorrect">A vein in the non-dominant arm</label><br/>
        <label><input type="checkbox" name="answer" value="incorrect">Veins on the dorsal and ventral surfaces of the upper extremitites.</label><br/>
        <label><input type="checkbox" name="answer" value="correct4">Veins in an upper extremity on the side of breast surgery</label>
      </div>
      <button type="button" onclick="checkAnswers('q1')">Submit</button>
      <div id="feedback1" class="feedback"></div>
      <button id="nextQ1Btn" class="disabled" onclick="manualNext('q1','q2')" disabled>Next</button>
    </form>
  </div>


  <!-- Question 2 -->
  <div class="question" id="q2">
    <h2>Question 2: What is the appropriate catheter gauge for rapid fluid replacement?</h2>
    <div class="options">
      <button onclick="handleClick('q2',true)">16-20</button>
      <button onclick="handleClick('q2',false)">20-24</button>
      <button onclick="handleClick('q2',false)">24-28</button>
    </div>
    <div id="feedback2" class="feedback"></div>
    <button id="nextQ2Btn" class="disabled" onclick="manualNext('q2','q3')" disabled>Next</button>
  </div>


  <!-- Question 3 (Click the correct boxes) -->
  <div class="question" id="q3">
    <h2>Question 3: Click all the correct sites on the image below</h2>

    <!-- Container for the background image + absolutely positioned boxes -->
    <div style="position:relative; display:inline-block;">
      <img src="periphal.jpeg" alt="IV Diagram" width="600" height="400" />
      <!-- You can add as many .clickable-zone boxes as you like. Example below: -->

      <!-- Box 1 (correct) at top=80px, left=100px, size=50x50. -->
      <div class="clickable-zone correct"
           style="top:80px; left:100px;"
           onclick="toggleClickZone(this)"></div>

      <!-- Box 2 (wrong) at top=200px, left=300px, size=50x50. -->
      <div class="clickable-zone wrong"
           style="top:200px; left:300px;"
           onclick="toggleClickZone(this)"></div>

      <!-- Box 3 (correct) at top=150px, left=400px, size=50x50. -->
      <div class="clickable-zone correct"
           style="top:150px; left:400px;"
           onclick="toggleClickZone(this)"></div>
    </div>

    <p>Tip: Correct boxes will show as green on hover if .correct, or red if .wrong. 
       We can further refine the styling as needed. 
    </p>

    <button onclick="checkQ3()">Submit</button>
    <div id="feedback3" class="feedback"></div>
    <button id="nextQ3Btn" class="disabled" onclick="manualNext('q3','q4')" disabled>Next</button>
  </div>


  <!-- Question 4 (Drag & Drop) -->
  <div class="question" id="q4">
    <h2>Question 4: Place the catheter gauge size from smallest to largest</h2>
    <p><em>Hint: bigger gauge number = smaller diameter. So 24 is smallest, 18 is largest.</em></p>

    <ul id="draggable-list">
      <li draggable="true" data-value="24">24</li>
      <li draggable="true" data-value="22">22</li>
      <li draggable="true" data-value="20">20</li>
      <li draggable="true" data-value="18">18</li>
    </ul>
    <button onclick="checkOrder()">Submit</button>
    <div id="feedback4" class="feedback"></div>
    <button id="nextQ4Btn" class="disabled" onclick="manualNext('q4','finalMessage')" disabled>Next</button>
  </div>


  <!-- Final Message -->
  <div id="finalMessage" class="question">
    <h2>Congratulations!</h2>
    <p>Your final score is: <strong><span id="finalScore"></span></strong></p>
    <p><button onclick="submitToLeaderboard()">Submit Score to Leaderboard</button></p>
  </div>


  <!-- Admin Section: Leaderboard -->
  <div id="adminSection">
    <h2>Leaderboard</h2>
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Score</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>

</main>

<!-- ============= FIREBASE CDN (ES MODULE) ============= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  const firebaseConfig = {
    /* Your Firebase Config */
    apiKey: "YOUR_API_KEY",
    authDomain: "iv-therapy-game.firebaseapp.com",
    projectId: "iv-therapy-game",
    storageBucket: "iv-therapy-game.appspot.com",
    messagingSenderId: "338220477391",
    appId: "1:338220477391:web:01c0785bf10404e42a40ba",
    measurementId: "G-9MEFL6Z5FS"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // Expose Firestore to the window, so the next script can access it
  window._quizDB = db;
  window.addDoc = addDoc;
  window.collection = collection;
  window.getDocs = getDocs;
  window.query = query;
  window.orderBy = orderBy;
</script>

<!-- ============= QUIZ + LEADERBOARD LOGIC ============= -->
<script>
  let score = 0;
  let timeLeft = 60;
  let timerId;
  let currentUser = "Anonymous"; 

  /***********************************************
   * START & TIMER
   ***********************************************/
  function promptUsername() {
    const name = prompt("Enter your name (or cancel for Anonymous):");
    currentUser = name ? name.trim() : "Anonymous";

    // Hide the opener, show main content
    document.getElementById("opener").style.display = "none";
    document.getElementById("main-content").style.display = "block";

    // Show player's name
    document.getElementById("playerName").textContent = currentUser;

    // Start on Q1
    startTimer("q1", "q2");
  }

  function startTimer(currentId, nextId) {
    const timerElement = document.getElementById("timer");
    timeLeft = 60; 
    clearInterval(timerId);

    timerId = setInterval(() => {
      timeLeft--;
      timerElement.textContent = `Time Left: ${timeLeft}s`;
      if (timeLeft <= 0) {
        clearInterval(timerId);
        // Move on automatically
        moveToNextQuestion(currentId, nextId);
      }
    }, 1000);
  }

  // Called by the "Next" button
  function manualNext(currentId, nextId) {
    // We also reset timer
    clearInterval(timerId);
    moveToNextQuestion(currentId, nextId);
  }

  function moveToNextQuestion(currentId, nextId) {
    document.getElementById(currentId).classList.remove("active");
    const nextQ = document.getElementById(nextId);
    if (nextQ) {
      nextQ.classList.add("active");
      if (nextId !== "finalMessage") {
        // Chain
        let upcomingNext;
        if (nextId === "q2") upcomingNext = "q3";
        else if (nextId === "q3") upcomingNext = "q4";
        else if (nextId === "q4") upcomingNext = "finalMessage";
        startTimer(nextId, upcomingNext);
      } else {
        // finalMessage
        document.getElementById("finalScore").textContent = score;
      }
    }
  }

  /***********************************************
   * Q1: CheckAnswers
   ***********************************************/
  function checkAnswers(currentId) {
    const selected = document.querySelectorAll(`#${currentId} input[name="answer"]:checked`);
    const correctAnswers = ["correct1", "correct2", "correct3", "correct4"];
    const selectedValues = Array.from(selected).map(i => i.value);
    const feedback = document.getElementById(`feedback${currentId.slice(-1)}`);

    const isCorrect =
      correctAnswers.every(a => selectedValues.includes(a)) &&
      !selectedValues.includes("incorrect") &&
      selectedValues.length === correctAnswers.length;

    if (isCorrect) {
      feedback.textContent = "Correct! Great job!";
      feedback.className = "feedback correct";
      score += 10;
    } else {
      feedback.textContent = "Oops! Some of your selections are incorrect.";
      feedback.className = "feedback incorrect";
      score -= 5;
    }
    document.getElementById("score").textContent = score;

    // Enable Next button
    const nextBtn = document.getElementById("nextQ1Btn");
    nextBtn.disabled = false;
    nextBtn.classList.remove("disabled");
  }

  /***********************************************
   * Q2: Single-Click
   ***********************************************/
  function handleClick(currentId, isCorrect) {
    const feedback = document.getElementById(`feedback${currentId.slice(-1)}`);
    if (isCorrect) {
      feedback.textContent = "Correct! Great job!";
      feedback.className = "feedback correct";
      score += 10;
    } else {
      feedback.textContent = "Wrong answer!";
      feedback.className = "feedback incorrect";
      score -= 5;
    }
    document.getElementById("score").textContent = score;

    // Enable Next
    const nextBtn = document.getElementById("nextQ2Btn");
    nextBtn.disabled = false;
    nextBtn.classList.remove("disabled");
  }


  /***********************************************
   * Q3: Clickable Zones
   ***********************************************/
  // Let the user click multiple correct/wrong boxes
  // We'll store which ones were clicked
  function toggleClickZone(elem) {
    // We can toggle a "selected" class or data attribute
    elem.classList.toggle("selected");
  }

  function checkQ3() {
    // Suppose .clickable-zone.correct => must be selected
    // .clickable-zone.wrong => must NOT be selected
    let feedback = document.getElementById("feedback3");

    const correctZones = document.querySelectorAll("#q3 .clickable-zone.correct");
    const wrongZones = document.querySelectorAll("#q3 .clickable-zone.wrong");

    // Check if every correct zone is selected
    const allCorrectSelected = Array.from(correctZones).every(z => z.classList.contains("selected"));
    // Check if any wrong zone is selected
    const anyWrongSelected = Array.from(wrongZones).some(z => z.classList.contains("selected"));

    if (allCorrectSelected && !anyWrongSelected) {
      feedback.textContent = "Correct! Great job!";
      feedback.className = "feedback correct";
      score += 10;
    } else {
      feedback.textContent = "Some boxes were incorrect or missed.";
      feedback.className = "feedback incorrect";
      score -= 5;
    }

    document.getElementById("score").textContent = score;

    // Enable Next
    const nextBtn = document.getElementById("nextQ3Btn");
    nextBtn.disabled = false;
    nextBtn.classList.remove("disabled");
  }


  /***********************************************
   * Q4: Drag & Drop
   ***********************************************/
  const draggableList = document.getElementById('draggable-list');
  let dragItem = null;
  if (draggableList) {
    const listItems = [...draggableList.querySelectorAll('li')];
    listItems.forEach(li => {
      li.addEventListener('dragstart', dragStart);
      li.addEventListener('dragend', dragEnd);
    });
    draggableList.addEventListener('dragover', dragOver);
    draggableList.addEventListener('drop', dropItem);
  }

  function dragStart(e) {
    dragItem = this;
    this.classList.add('dragging');
    e.dataTransfer.setData('text/plain', '');
  }
  function dragEnd() {
    this.classList.remove('dragging');
    dragItem = null;
  }
  function dragOver(e) {
    e.preventDefault();
  }
  function dropItem(e) {
    e.preventDefault();
    if (dragItem) {
      const listItems = [...draggableList.querySelectorAll('li:not(.dragging)')];
      const afterElement = listItems.find(li => {
        const rect = li.getBoundingClientRect();
        return e.clientY < rect.top + rect.height / 2;
      });
      if (!afterElement) {
        draggableList.appendChild(dragItem);
      } else {
        draggableList.insertBefore(dragItem, afterElement);
      }
    }
  }

  function checkOrder() {
    const feedback = document.getElementById('feedback4');
    const correctOrder = ['24','22','20','18'];
    const liElements = document.querySelectorAll('#draggable-list li');
    const userOrder = [...liElements].map(li => li.getAttribute('data-value'));

    if (JSON.stringify(userOrder) === JSON.stringify(correctOrder)) {
      feedback.textContent = "Correct order! Great job!";
      feedback.className = "feedback correct";
      score += 10;
    } else {
      feedback.textContent = "Incorrect order. Smaller # = bigger gauge!";
      feedback.className = "feedback incorrect";
      score -= 5;
    }
    document.getElementById("score").textContent = score;

    // Enable Next
    const nextBtn = document.getElementById("nextQ4Btn");
    nextBtn.disabled = false;
    nextBtn.classList.remove("disabled");
  }


  /***********************************************
   * Submit Score & Admin
   ***********************************************/
  async function submitToLeaderboard() {
    try {
      const { addDoc, collection } = window;
      await addDoc(collection(window._quizDB, "scores"), {
        username: currentUser,
        score,
        date: new Date().toISOString()
      });
      alert("Score submitted to leaderboard!");
    } catch (err) {
      console.error("Error saving score:", err);
      alert("Error saving score: " + err.message);
    }
  }

  function adminLogin() {
    const pass = prompt("Enter Admin Password (demo only):");
    if (pass === "admin123") {
      document.getElementById("adminSection").style.display = "block";
      loadLeaderboard();
    } else {
      alert("Incorrect admin password!");
    }
  }

  async function loadLeaderboard() {
    const { getDocs, query, collection, orderBy } = window;
    const tbody = document.getElementById("leaderboardBody");
    tbody.innerHTML = "Loading...";

    try {
      const q = query(collection(window._quizDB, "scores"), orderBy("date", "desc"));
      const snapshot = await getDocs(q);

      let html = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        html += `<tr>
          <td>${data.username}</td>
          <td>${data.score}</td>
          <td>${data.date}</td>
        </tr>`;
      });
      tbody.innerHTML = html || "<tr><td colspan='3'>No scores found</td></tr>";
    } catch (err) {
      console.error("Error loading leaderboard:", err);
      tbody.innerHTML = "<tr><td colspan='3'>Error loading data</td></tr>";
    }
  }
</script>
</body>
</html>
