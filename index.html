<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>IV Therapy Interactive Game</title>
  <style>
    /* Basic Styles */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f3f4f6;
    }
    header {
      background-color: #0078D7;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.8rem;
    }
    .opener {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f9f9f9;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .opener img {
      max-width: 80%;
      height: auto;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .opener h1 {
      font-size: 2rem;
      color: #333;
    }
    .opener p {
      font-size: 1.2rem;
      color: #555;
      margin: 10px 0 20px;
      line-height: 1.5;
    }
    .opener button {
      padding: 15px 30px;
      font-size: 1.2rem;
      border: none;
      background-color: #0078D7;
      color: white;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    .opener button:hover {
      background-color: #005bb5;
    }
    main {
      padding: 20px;
      display: none; /* Initially hide the main content */
      max-width: 900px;
      margin: 0 auto;
    }
    .question {
      display: none; /* Hide all questions initially */
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .question.active {
      display: block; /* Show only the active question */
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background-color: #0078D7;
      color: white;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #005bb5;
    }
    .feedback {
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.2rem;
    }
    .feedback.correct {
      color: green;
    }
    .feedback.incorrect {
      color: red;
    }
    #scoreBoard {
      margin-bottom: 20px;
      font-size: 1.2rem;
      color: #333;
      text-align: center;
    }
    #timer {
      font-size: 1.2rem;
      color: #FF0000;
      text-align: center;
      margin-bottom: 20px;
    }
    #finalMessage {
      display: none;
      text-align: center;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    /* --- STYLING FOR Q4 DRAG-AND-DROP --- */
    #draggable-list {
      list-style-type: none;
      margin: 0 auto;
      padding: 0;
      max-width: 250px;
      min-width: 200px;
    }
    #draggable-list li {
      padding: 15px;
      margin: 8px 0;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: move; /* Indicate draggable item */
      user-select: none;
      text-align: center;
      font-size: 1.1rem;
    }
    /* When dragging */
    .dragging {
      opacity: 0.5;
    }

    /* Admin / Leaderboard styling */
    #adminSection {
      display: none; /* Hidden by default */
      background: #fff;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #adminSection table {
      width: 100%;
      border-collapse: collapse;
    }
    #adminSection th, #adminSection td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
  </style>
</head>
<body>

<!-- Opener Screen -->
<div class="opener" id="opener">
  <!-- Update your image path to point to images/ folder in your GitHub repo -->
  <img src="/prisma-health-2-1.jpg" alt="IV Therapy Kahoot Challenge">
  <h1>IV Therapy Challenge</h1>
  <p>Welcome to the IV Therapy Interactive Game</p>
  <button onclick="promptUsername()">Start Game</button>
</div>

<!-- Game Section -->
<header>IV Therapy Interactive Game</header>
<main id="main-content">
  <!-- Admin login button / scoreboard toggler -->
  <div style="text-align:right; margin-bottom:10px;">
    <button onclick="adminLogin()">Admin Login</button>
  </div>

  <div id="scoreBoard">
    <strong>Score:</strong> <span id="score">0</span>
    <br/>
    <strong>Player:</strong> <span id="playerName"></span>
  </div>
  <div id="timer">Time Left: 60s</div>

  <!-- Question 1-->
  <div class="question active" id="q1">
    <h2>Question 1: What are common sites to avoid when starting an IV? (Select all that apply)</h2>
    <img src="iv_placement.jpeg" 
         alt="IV Placement Guide" 
         style="max-width: 100%; height: auto; margin-bottom: 15px;">
        
    <form id="q1-form">
      <div class="options">
        <label>
          <input type="checkbox" name="answer" value="correct1">
          Extremities with an AV Fistula, graft, or known clot
        </label><br/>
        <label>
          <input type="checkbox" name="answer" value="correct2">
          Extremity affected by stroke, radiation therapy, or lymphedema
        </label><br/>
        <label>
          <input type="checkbox" name="answer" value="correct3">
          Areas of flexion, lower extremity, or open wounds
        </label><br/>
        <label>
          <input type="checkbox" name="answer" value="incorrect">
          A vein in the non-dominant arm
        </label><br/>
        <label>
          <input type="checkbox" name="answer" value="incorrect">
          Veins on the dorsal and ventral surfaces of the upper extremitites.
        </label><br/>
        <label>
          <input type="checkbox" name="answer" value="correct4">
          Veins in an upper extremity on the side of breast surgery
        </label>
      </div>
      <button type="button" onclick="checkAnswers('q1','q2')">Submit</button>
    </form>
    <div id="feedback1" class="feedback"></div>
  </div>

  <!-- Question 2 -->
  <div class="question" id="q2">
    <h2>Question 2: What is the appropriate catheter gauge for rapid fluid replacement?</h2>
    <div class="options">
      <button onclick="handleClick('q2','q3', true)">16-20</button>
      <button onclick="handleClick('q2','q3', false)">20-24</button>
      <button onclick="handleClick('q2','q3', false)">24-28</button>
    </div>
    <div id="feedback2" class="feedback"></div>
  </div>
  
  <!-- Question 3 -->
  <div class="question" id="q3">
    <h2>Choose the correct sites to start a peripheral IV</h2>

    <img 
      src="periphal.jpeg"
      alt="IV Diagram"
      usemap="#iv-map"
      width="1800"
      height="1200"
      style="display:block; max-width:100%; height:auto; margin:0 auto;"
    />

    <map name="iv-map">
      <area 
        shape="circle"
        coords="450,600,90"
        alt="Correct Vein"
        onclick="showFeedback(true, 'q3', 'q4')"
      />
      <area 
        shape="circle"
        coords="900,1200,90"
        alt="Wrong Vein"
        onclick="showFeedback(false, 'q3', 'q4')"
      />
    </map>
    <div id="feedback3" class="feedback"></div>
  </div>

  <!-- Question 4 (Drag & Drop) -->
  <div class="question" id="q4">
    <h2>Question 4: Place the catheter gauge size from smallest to largest</h2>
    <p><em>Hint: bigger gauge number = smaller diameter. So 24 is smallest, 18 is largest.</em></p>

    <ul id="draggable-list">
      <li draggable="true" data-value="24">24</li>
      <li draggable="true" data-value="22">22</li>
      <li draggable="true" data-value="20">20</li>
      <li draggable="true" data-value="18">18</li>
    </ul>

    <button onclick="checkOrder('q4','finalMessage')">Submit Order</button>
    <div id="feedback4" class="feedback"></div>
  </div>

  <!-- Final Message -->
  <div id="finalMessage">
    <h2>Congratulations!</h2>
    <p>Your final score is: <strong><span id="finalScore"></span></strong></p>
    <p><button onclick="submitToLeaderboard()">Submit Score to Leaderboard</button></p>
  </div>

  <!-- Admin Section: Leaderboard -->
  <div id="adminSection">
    <h2>Leaderboard</h2>
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Score</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>
</main>

<!-- ============= FIREBASE CDN (ES MODULE) ============= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  const firebaseConfig = {
    /* === REPLACE WITH YOUR FIREBASE CONFIG === */
    apiKey: "YOUR_API_KEY",
    authDomain: "iv-therapy-game.firebaseapp.com",
    projectId: "iv-therapy-game",
    storageBucket: "iv-therapy-game.appspot.com",
    messagingSenderId: "338220477391",
    appId: "1:338220477391:web:01c0785bf10404e42a40ba",
    measurementId: "G-9MEFL6Z5FS"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // Expose Firestore to the window, so the next script can access it
  window._quizDB = db;
  window.addDoc = addDoc;
  window.collection = collection;
  window.getDocs = getDocs;
  window.query = query;
  window.orderBy = orderBy;
</script>

<!-- ============= QUIZ + LEADERBOARD LOGIC ============= -->
<script>
  let score = 0;
  let timeLeft = 60;
  let timerId;
  let currentUser = "Anonymous"; // Set via promptUsername()

  function promptUsername() {
    const name = prompt("Enter your name (or cancel for Anonymous):");
    currentUser = name ? name.trim() : "Anonymous";

    // Hide the opener, show main content
    document.getElementById("opener").style.display = "none";
    document.getElementById("main-content").style.display = "block";
    
    // Display player's name
    document.getElementById("playerName").textContent = currentUser;

    // Start the quiz
    startTimer("q1","q2");
  }

  function startTimer(currentId, nextId) {
    const timerElement = document.getElementById("timer");
    timeLeft = 60; 
    clearInterval(timerId);

    timerId = setInterval(() => {
      timeLeft--;
      timerElement.textContent = `Time Left: ${timeLeft}s`;
      if (timeLeft <= 0) {
        clearInterval(timerId);
        moveToNextQuestion(currentId, nextId);
      }
    }, 1000);
  }

  function moveToNextQuestion(currentId, nextId) {
    document.getElementById(currentId).classList.remove("active");
    const nextQuestion = document.getElementById(nextId);

    if (nextQuestion) {
      nextQuestion.classList.add("active");
      if (nextId !== "finalMessage") {
        let upcomingNext;
        if (nextId === "q2") upcomingNext = "q3";
        else if (nextId === "q3") upcomingNext = "q4";
        else if (nextId === "q4") upcomingNext = "finalMessage";
        startTimer(nextId, upcomingNext);
      } else {
        // final message
        document.getElementById("finalScore").textContent = score;
        clearInterval(timerId);
      }
    }
  }

  // Q1 (multiple checkbox)
  function checkAnswers(currentId, nextId) {
    const selected = document.querySelectorAll(`#${currentId} input[name="answer"]:checked`);
    const correctAnswers = ["correct1", "correct2", "correct3", "correct4"];
    const selectedValues = Array.from(selected).map(input => input.value);
    const feedback = document.getElementById(`feedback${currentId.slice(-1)}`);

    const isCorrect = 
      correctAnswers.every(a => selectedValues.includes(a)) &&
      !selectedValues.includes("incorrect") &&
      selectedValues.length === correctAnswers.length;

    if (isCorrect) {
      feedback.textContent = "Correct! Great job!";
      feedback.className = "feedback correct";
      score += 10;
    } else {
      feedback.textContent = "Oops! Some of your selections are incorrect.";
      feedback.className = "feedback incorrect";
      score -= 5;
    }
    document.getElementById("score").textContent = score;

    setTimeout(() => moveToNextQuestion(currentId, nextId), 1000);
  }

  // Q2 (single-click)
  function handleClick(currentId, nextId, isCorrect) {
    const feedback = document.getElementById(`feedback${currentId.slice(-1)}`);
    if (isCorrect) {
      feedback.textContent = "Correct! Great job!";
      feedback.className = "feedback correct";
      score += 10;
    } else {
      feedback.textContent = "Wrong answer!";
      feedback.className = "feedback incorrect";
      score -= 5;
    }
    document.getElementById("score").textContent = score;

    setTimeout(() => moveToNextQuestion(currentId, nextId), 1000);
  }

  // Q3 (image map)
  function showFeedback(isCorrect, currentId, nextId) {
    const feedback = document.getElementById(`feedback${currentId.slice(-1)}`);
    if (isCorrect) {
      feedback.textContent = "Correct! Great job!";
      feedback.className = "feedback correct";
      score += 10;
    } else {
      feedback.textContent = "Wrong area!";
      feedback.className = "feedback incorrect";
      score -= 5;
    }
    document.getElementById("score").textContent = score;

    setTimeout(() => moveToNextQuestion(currentId, nextId), 1000);
  }

  // Q4 (drag & drop)
  const draggableList = document.getElementById('draggable-list');
  let dragItem = null;

  if (draggableList) {
    const listItems = [...draggableList.querySelectorAll('li')];
    listItems.forEach(li => {
      li.addEventListener('dragstart', dragStart);
      li.addEventListener('dragend', dragEnd);
    });
    draggableList.addEventListener('dragover', dragOver);
    draggableList.addEventListener('drop', dropItem);
  }

  function dragStart(e) {
    dragItem = this;
    this.classList.add('dragging');
    e.dataTransfer.setData('text/plain', '');
  }
  function dragEnd() {
    this.classList.remove('dragging');
    dragItem = null;
  }
  function dragOver(e) {
    e.preventDefault();
  }
  function dropItem(e) {
    e.preventDefault();
    if (dragItem) {
      const listItems = [...draggableList.querySelectorAll('li:not(.dragging)')];
      const afterElement = listItems.find(li => {
        const rect = li.getBoundingClientRect();
        return e.clientY < rect.top + rect.height / 2;
      });
      if (!afterElement) {
        draggableList.appendChild(dragItem);
      } else {
        draggableList.insertBefore(dragItem, afterElement);
      }
    }
  }

  function checkOrder(currentId, nextId) {
    const feedback = document.getElementById('feedback4');
    const correctOrder = ['24', '22', '20', '18'];
    const liElements = document.querySelectorAll('#draggable-list li');
    const userOrder = [...liElements].map(li => li.getAttribute('data-value'));

    if (JSON.stringify(userOrder) === JSON.stringify(correctOrder)) {
      feedback.textContent = "Correct order! Great job!";
      feedback.className = "feedback correct";
      score += 10;
    } else {
      feedback.textContent = "Incorrect order. Remember the smaller the number, the bigger the gauge!";
      feedback.className = "feedback incorrect";
      score -= 5;
    }
    document.getElementById("score").textContent = score;
    setTimeout(() => moveToNextQuestion(currentId, nextId), 1000);
  }

  // Submit Score
  async function submitToLeaderboard() {
    try {
      const { addDoc, collection } = window;
      await addDoc(collection(window._quizDB, "scores"), {
        username: currentUser,
        score,
        date: new Date().toISOString()
      });
      alert("Score submitted to leaderboard!");
    } catch (err) {
      console.error("Error saving score:", err);
      alert("Error saving score: " + err.message);
    }
  }

  // Admin / Load Leaderboard
  function adminLogin() {
    const pass = prompt("Enter Admin Password (demo only):");
    if (pass === "admin123") {
      document.getElementById("adminSection").style.display = "block";
      loadLeaderboard();
    } else {
      alert("Incorrect admin password!");
    }
  }

  async function loadLeaderboard() {
    const { getDocs, query, collection, orderBy } = window;
    const tbody = document.getElementById("leaderboardBody");
    tbody.innerHTML = "Loading...";

    try {
      const q = query(collection(window._quizDB, "scores"), orderBy("date", "desc"));
      const snapshot = await getDocs(q);

      let html = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        html += `
          <tr>
            <td>${data.username}</td>
            <td>${data.score}</td>
            <td>${data.date}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html || "<tr><td colspan='3'>No scores found</td></tr>";
    } catch (err) {
      console.error("Error loading leaderboard:", err);
      tbody.innerHTML = "<tr><td colspan='3'>Error loading data</td></tr>";
    }
  }
</script>
</body>
</html>
